name: Publish

on:
  workflow_dispatch:
  push:
    branches: [main]
  release:
    types: [published]

jobs:
  publish-npm:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        node-version: [24]
        project: [lib, jam, convert]

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'

    - name: Install dependencies
      run: npm ci

    - name: Build @typeberry/${{ matrix.project }}
      run: npm run build -w @typeberry/${{ matrix.project }}
      env:
        IS_RELEASE: ${{ github.event_name == 'release' && !github.event.release.prerelease && '1' || '' }}

    - name: Determine npm tag
      id: npm-tag
      run: |
        if [[ "${{ github.event_name }}" == "release" && "${{ github.event.release.prerelease }}" != "true" ]]; then
          echo "tag=latest" >> $GITHUB_OUTPUT
        else
          echo "tag=next" >> $GITHUB_OUTPUT
        fi

    - name: Get package version
      id: pkg-version
      working-directory: ./dist/${{ matrix.project }}
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Check if version exists on npm
      id: check-version
      run: |
        if npm view @typeberry/${{ matrix.project }}@${{ steps.pkg-version.outputs.version }} version 2>/dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Publish @typeberry/${{ matrix.project }}
      if: steps.check-version.outputs.exists == 'false'
      working-directory: ./dist/${{ matrix.project }}
      run: npm publish --access public --tag ${{ steps.npm-tag.outputs.tag }}

    - name: Tag existing version
      if: steps.check-version.outputs.exists == 'true'
      run: npm dist-tag add @typeberry/${{ matrix.project }}@${{ steps.pkg-version.outputs.version }} ${{ steps.npm-tag.outputs.tag }}

  publish-docker:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4
    - uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract version from package.json
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ghcr.io/${{ github.repository_owner }}/typeberry
        tags: |
          type=semver,pattern={{version}},value=${{ steps.version.outputs.version }}
          type=raw,value=latest,enable=${{ github.event_name == 'release' && !github.event.release.prerelease }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

  update-release-notes:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    needs: [publish-npm, publish-docker]
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Compute release version (strip leading v)
      id: ver
      run: |
        RAW="${{ github.event.release.tag_name }}"
        echo "version=${RAW#v}" >> "$GITHUB_OUTPUT"

    - name: Update Release Notes
      uses: softprops/action-gh-release@v1
      with:
        body: |
          ## ğŸ³ Docker Images

          ```bash
          # GitHub Container Registry
          docker pull ghcr.io/${{ github.repository_owner }}/typeberry:${{ steps.ver.outputs.version }}
          ```

          ## ğŸ“¦ NPM Packages

          ```bash
          npm install @typeberry/lib@${{ steps.ver.outputs.version }}
          npm install @typeberry/jam@${{ steps.ver.outputs.version }}
          ```

          ---
          ${{ github.event.release.body }}
        append_body: true
